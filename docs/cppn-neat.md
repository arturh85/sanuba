# CPPN-NEAT: Procedural Morphology Generation

Sunaba's creatures don't have hand-designed bodies. Instead, their morphologies are procedurally generated by **Compositional Pattern Producing Networks (CPPNs)**, evolved using **NeuroEvolution of Augmenting Topologies (NEAT)**.

## The Problem: Designing Bodies

How do you create diverse, functional creature morphologies without hand-designing each one?

Nature's solution is development — a genetic blueprint (genotype) unfolds into a physical body (phenotype) through growth processes. The same approach can work for artificial creatures.

## Compositional Pattern Producing Networks (CPPNs)

### What is a CPPN?

A CPPN is a neural network that generates patterns by taking spatial coordinates as input and outputting values that determine properties at those locations.

```mermaid
flowchart LR
    subgraph Inputs
        X[x coordinate]
        Y[y coordinate]
        D[distance from center]
    end

    subgraph "CPPN Network"
        H1[Hidden Layer]
        H2[Hidden Layer]
    end

    subgraph Outputs
        M[Material presence]
        J[Joint type]
        S[Segment ID]
    end

    X --> H1
    Y --> H1
    D --> H1
    H1 --> H2
    H2 --> M
    H2 --> J
    H2 --> S
```

### Why CPPNs Work

CPPNs leverage **geometric regularities** found in natural organisms:

| Regularity | Activation Function | Effect |
|------------|---------------------|--------|
| Symmetry | Gaussian (distance) | Bilateral symmetry |
| Repetition | Sine | Repeating segments |
| Gradients | Linear | Smooth transitions |
| Sharp boundaries | Step | Distinct regions |

By combining these functions, CPPNs can produce:
- Bilaterally symmetric bodies
- Repeating limb segments
- Smooth body contours
- Distinct organs/regions

### Activation Functions

CPPNs use diverse activation functions, each contributing different geometric properties:

```mermaid
flowchart TB
    subgraph "Activation Functions"
        direction LR
        A1["sin(x): Repetition"]
        A2["gauss(x): Symmetry"]
        A3["sigmoid(x): Gradients"]
        A4["step(x): Boundaries"]
        A5["abs(x): V-shapes"]
    end
```

**Sine** — Creates repeating, periodic patterns (limb segments, stripes)

**Gaussian** — Creates radially symmetric patterns (eyes, body centers)

**Sigmoid** — Creates smooth gradients (density variations, tapers)

**Step** — Creates sharp boundaries (distinct body regions)

**Absolute value** — Creates V-shaped patterns (limb bifurcations)

### CPPN Query Process

To generate a creature body, we query the CPPN at many spatial coordinates:

```mermaid
flowchart TD
    A[Define query grid] --> B[For each point x,y]
    B --> C[Compute distance d from origin]
    C --> D[Feed x,y,d into CPPN]
    D --> E[Get output values]
    E --> F{material_presence > threshold?}
    F -->|Yes| G[Create body segment]
    F -->|No| H[Empty space]
    G --> I[Assign joint type from output]
    I --> B
```

## NEAT: NeuroEvolution of Augmenting Topologies

### The Challenge of Evolving Network Topology

Traditional neuroevolution fixes the network architecture and only evolves weights. But optimal topology varies by problem. NEAT solves this by evolving both topology and weights simultaneously.

### Historical Markings

NEAT's key innovation is **historical markings** — every gene (connection) receives a unique global ID when created:

```
Gene 1: Node A → Node B (innovation #1)
Gene 2: Node B → Node C (innovation #2)
Gene 3: Node A → Node C (innovation #3)  ← New connection
```

These markings enable meaningful crossover between networks with different topologies.

### Crossover with Historical Genes

```mermaid
flowchart TD
    subgraph "Parent 1"
        P1["Genes: 1, 2, 3, 4, 8"]
    end

    subgraph "Parent 2"
        P2["Genes: 1, 2, 3, 5, 6, 7"]
    end

    subgraph "Matching"
        M["1, 2, 3 — randomly inherit from either parent"]
    end

    subgraph "Disjoint/Excess"
        D["4, 5, 6, 7, 8 — inherit from fitter parent"]
    end

    P1 --> M
    P2 --> M
    P1 --> D
    P2 --> D
    M --> C[Child Genome]
    D --> C
```

### Speciation

NEAT protects innovation through **speciation**. New topological structures initially perform poorly but may lead to better solutions. By grouping similar genomes into species, NEAT prevents premature convergence.

Species distance:

```
δ = c₁(E/N) + c₂(D/N) + c₃·W̄
```

Where:
- E = excess genes
- D = disjoint genes
- W̄ = average weight difference
- N = normalizing factor (genome size)

### Mutation Operators

```mermaid
flowchart LR
    subgraph "Structural Mutations"
        A1[Add Node] --> A2["Split existing connection\nA→B becomes A→C→B"]
        B1[Add Connection] --> B2["New edge between\nexisting nodes"]
    end

    subgraph "Weight Mutations"
        C1[Perturb Weights] --> C2["Small random changes\nto connection weights"]
        D1[Reset Weight] --> D2["Replace with new\nrandom value"]
    end
```

## CPPN-NEAT for Morphology

Combining CPPN and NEAT creates a powerful system for evolving creature bodies.

### The Genotype-Phenotype Mapping

```mermaid
flowchart TD
    subgraph Genotype
        G[CPPN-NEAT Genome]
        G --> |Encodes| N[CPPN Network Topology]
        G --> |Encodes| W[Connection Weights]
    end

    subgraph Development
        N --> Q[Query at spatial coordinates]
        W --> Q
        Q --> O[Output values per location]
    end

    subgraph Phenotype
        O --> B[Body segments]
        O --> J[Joint placements]
        O --> M[Motor attachments]
    end
```

### CPPN Outputs for Sunaba Creatures

| Output | Interpretation |
|--------|----------------|
| body_presence | Whether material exists at this point (threshold) |
| segment_id | Which body segment this belongs to |
| joint_type | 0=none, 1=revolute, 2=prismatic, 3=fixed |
| motor_strength | Maximum torque for motorized joints |
| limb_thickness | Radius of body at this point |

### Example: How a Limb Emerges

Consider a CPPN with a sine function in its hidden layer:

1. Query points along the x-axis
2. Sine function creates periodic output
3. High values → body present
4. Periodic high values → segmented limb
5. Joint outputs between segments → articulated limb

```mermaid
flowchart LR
    subgraph "Query Points"
        P1[x=0] --> V1[high]
        P2[x=0.5] --> V2[low]
        P3[x=1.0] --> V3[high]
        P4[x=1.5] --> V4[low]
        P5[x=2.0] --> V5[high]
    end

    subgraph "Result"
        V1 --> S1[Segment 1]
        V3 --> S2[Segment 2]
        V5 --> S3[Segment 3]
        S1 ---|joint| S2
        S2 ---|joint| S3
    end
```

## In Sunaba

### Joint Types

Sunaba creatures can have three joint types:

**Revolute** — Rotation around a point (like an elbow)
- 1 degree of freedom
- Motor applies torque
- Used for walking, swimming

**Prismatic** — Linear sliding (like a piston)
- 1 degree of freedom
- Motor applies force
- Used for jumping, striking

**Fixed** — Rigid connection
- 0 degrees of freedom
- Structural support
- Used for body cores

### Morphology Constraints

To ensure physically viable creatures:

- Minimum body mass threshold
- Maximum aspect ratio
- Connectivity requirements (no floating parts)
- Joint limits to prevent self-intersection

### Evolved Morphology Examples

Evolution produces diverse body plans:

- **Worm-like**: Long chains of segments with revolute joints
- **Spider-like**: Central body with radiating limbs
- **Blob-like**: Compact bodies with few joints
- **Snake-like**: Undulating chains using prismatic joints

## Benefits of CPPN-NEAT

1. **Indirect encoding** — Small genomes produce complex bodies
2. **Geometric regularities** — Natural symmetry and repetition
3. **Evolvability** — Small mutations produce meaningful variations
4. **Open-ended** — Topology can grow without bound

## References

- Stanley, K.O. (2007). "Compositional Pattern Producing Networks: A Novel Abstraction of Development." *Genetic Programming and Evolvable Machines*.
- Stanley, K.O. & Miikkulainen, R. (2002). "Evolving Neural Networks through Augmenting Topologies." *Evolutionary Computation*.
- Cheney, N., MacCurdy, R., Clune, J., & Lipson, H. (2013). "Unshackling Evolution: Evolving Soft Robots with Multiple Materials and a Powerful Generative Encoding." *GECCO*.
- Clune, J., Stanley, K.O., Pennock, R.T., & Ofria, C. (2011). "On the Performance of Indirect Encoding Across the Continuum of Regularity." *IEEE TEVC*.
